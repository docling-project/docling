# syntax=docker/dockerfile:1.7
FROM python:3.12-slim-bookworm AS base

ENV DEBIAN_FRONTEND=noninteractive \
    VIRTUAL_ENV=/app/.venv \
    PATH="/app/.venv/bin:${PATH}" \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# í•„ìˆ˜ íˆ´
RUN apt-get update && apt-get install -y --no-install-recommends \
      curl ca-certificates tini supervisor git build-essential \
    && rm -rf /var/lib/apt/lists/*

# uv ë°”ì´ë„ˆë¦¬
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

WORKDIR /app

# ğŸ‘‡ ë„¤ í”„ë¡œì íŠ¸ pyprojectë§Œ ë¨¼ì €
COPY serving/ocr_paddle_server/pyproject.toml /app/pyproject.toml
# í•„ìš”í•˜ë©´ READMEë„
# COPY serving/ocr_paddle_server/README.md /app/README.md

# ğŸ‘‡ ì—¬ê¸°ì„œ uvê°€ paddleê¹Œì§€ ì „ë¶€ ì„¤ì¹˜
# (pyprojectì˜ [tool.uv]ì— extra-index-urlì´ ìˆê¸° ë•Œë¬¸ì— ê°€ëŠ¥)
RUN --mount=type=cache,target=/root/.cache/uv \
    uv venv /app/.venv && \
    uv sync --frozen || uv sync

# ì•± ì½”ë“œ
COPY serving/ocr_paddle_server /app

# ë¡œê·¸ ë””ë ‰í„°ë¦¬
RUN mkdir -p /var/log/supervisor /var/log/paddlex

EXPOSE 8080

CMD ["/usr/bin/tini", "--", "supervisord", "-n", "-c", "/app/config/supervisord.conf"]
